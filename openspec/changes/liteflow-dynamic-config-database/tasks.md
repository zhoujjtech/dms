# Implementation Tasks: LiteFlow Database Dynamic Configuration

## 1. 依赖和环境准备

- [x] 1.1 升级 `liteflow-rule-sql` 依赖到 2.15.0.2
  - 在 `dms-liteflow-infrastructure/pom.xml` 添加依赖
  - 验证与现有 LiteFlow 2.12.4 版本兼容性

- [x] 1.2 导出现有静态配置
  - 从 `classpath:flow/` 导出所有 XML 配置文件
  - 将 XML 配置转换为数据库 INSERT 语句
  - 准备初始配置数据脚本

- [x] 1.3 创建数据库迁移脚本
  - 创建 `V2__add_liteflow_sql_plugin_fields.sql` 迁移脚本
  - 扩展 `flow_chain` 表字段
  - 扩展 `rule_component` 表字段
  - 添加必要的索引

- [x] 1.4 准备数据迁移脚本
  - 创建现有数据更新脚本（设置默认值）
  - 准备回滚脚本（DROP 新增字段）
  - 在测试环境验证迁移脚本

## 2. 数据库迁移和验证

- [ ] 2.1 在测试环境执行数据库迁移
  - 执行表结构扩展脚本
  - 执行数据迁移脚本
  - 验证数据完整性

- [ ] 2.2 导入初始配置数据
  - 从转换的 INSERT 语句导入流程链配置
  - 从转换的 INSERT 语句导入组件配置
  - 验证导入后的配置数据

- [ ] 2.3 验证数据库查询性能
  - 执行 EXPLAIN 分析新增索引效果
  - 测试带租户过滤的查询性能
  - 优化慢查询（如有）

## 3. 自定义 RuleDataSource 实现

- [x] 3.1 创建 `CustomJdbcRuleSource` 类
  - 在 `dms-liteflow-infrastructure` 模块创建类
  - 继承 `JdbcRuleSource` (LiteFlow SQL 插件)
  - 重写 SQL 构建方法以支持租户过滤

- [x] 3.2 实现租户ID注入机制
  - 从 `TenantContext` 获取当前租户ID
  - 在 SQL 执行前注入 `tenant_id` 参数
  - 处理租户ID为空的默认情况

- [x] 3.3 实现自定义 SQL 查询
  - 实现 flow_chain 表的自定义查询
  - 实现 rule_component 表的自定义查询
  - 添加 PUBLISHED 状态过滤

- [x] 3.4 注册 CustomJdbcRuleSource Bean
  - 创建 `LiteFlowConfig` 配置类
  - 注册 `CustomJdbcRuleSource` 为 Spring Bean
  - 配置必要的 SQL 插件参数
  - 注册 `CustomJdbcRuleSource` 为 Spring Bean
  - 配置必要的 SQL 插件参数

## 4. 配置文件调整

- [x] 4.1 修改 `application.yml` 配置
  - 移除 `liteflow.rule-source: configData`
  - 移除 `liteflow.configData: classpath:flow/`
  - 添加 `liteflow.rule-source-ext-data-map` 配置

- [x] 4.2 配置 SQL 插件参数
  - 配置 `applicationName: dms-liteflow`
  - 配置轮询参数（60秒间隔）
  - 配置表名和字段映射

- [x] 4.3 配置多租户相关设置
  - 添加自定义 SQL 配置（如需要）
  - 配置默认租户ID
  - 配置租户上下文拦截器

## 5. 辅助服务调整

- [x] 5.1 调整 `FlowConfigService`
  - 保留配置查询 API 功能
  - 保留缓存管理功能
  - 移除向 LiteFlow 注入配置的代码

- [x] 5.2 调整 `FlowConfigLoader`
  - 更新 SQL 查询以适配新表结构
  - 添加 `application_name` 字段处理
  - 添加 `chain_enable` / `script_enable` 字段过滤

- [x] 5.3 新增手动刷新 API
  - 在 `FlowConfigController` 添加 `POST /admin/config/refresh` 接口
  - 支持按租户ID刷新配置
  - 支持全局配置刷新

## 6. 单元测试

- [x] 6.1 测试 CustomJdbcRuleSource
  - 测试租户ID正确注入到 SQL
  - 测试默认租户ID处理
  - 测试配置加载逻辑

- [ ] 6.2 测试 FlowConfigService
  - 测试配置查询功能
  - 测试缓存清理功能
  - 测试多租户配置隔离

- [x] 6.3 测试手动刷新 API
  - 测试全局刷新接口
  - 测试指定租户刷新接口
  - 测试刷新结果返回

## 7. 集成测试

- [x] 7.1 测试应用启动配置加载
  - 验证应用启动时从数据库加载配置
  - 验证 LiteFlow 引擎正确初始化
  - 验证配置加载失败时的降级处理

- [x] 7.2 测试多租户配置隔离
  - 创建租户 A 和租户 B 的相同名称流程链
  - 验证租户 A 请求使用租户 A 配置
  - 验证租户 B 请求使用租户 B 配置
  - 验证配置互不干扰

- [ ] 7.3 测试配置自动刷新
  - 修改数据库中的流程链配置
  - 等待 60 秒轮询周期
  - 验证配置自动刷新生效
  - 验证日志记录刷新事件

- [ ] 7.4 测试配置刷新不影响正在执行的任务
  - 触发配置刷新
  - 验证正在执行的流程任务继续使用旧配置
  - 验证新请求使用新配置

- [ ] 7.5 测试分布式多实例配置同步
  - 启动多个应用实例
  - 修改数据库配置
  - 验证所有实例在下一个轮询周期同步配置
  - 验证最终一致性

## 8. 性能测试

- [ ] 8.1 测试配置加载性能
  - 测试应用启动时配置加载时间
  - 测试首次请求配置加载时间
  - 验证满足性能要求（< 1秒）

- [ ] 8.2 测试轮询刷新对性能的影响
  - 监控轮询期间 CPU 和内存使用
  - 验证轮询不影响请求处理性能
  - 调整轮询间隔（如需要）

- [ ] 8.3 测试多租户查询性能
  - 测试带租户过滤的查询响应时间
  - 验证缓存效果
  - 优化慢查询（如有）

## 9. 监控和日志

- [x] 9.1 添加配置加载监控
  - 记录配置加载成功/失败事件
  - 添加配置加载状态健康检查
  - 添加配置加载失败告警

- [x] 9.2 添加配置刷新监控
  - 记录每次配置刷新事件
  - 记录刷新的配置数量和类型
  - 添加配置刷新失败告警

- [x] 9.3 优化日志输出
  - 配置加载成功时记录 INFO 日志
  - 配置加载失败时记录 ERROR 日志
  - 配置刷新时记录 DEBUG 日志

## 10. 文档更新

- [ ] 10.1 更新配置管理指南
  - 添加数据库配置源说明
  - 添加多租户配置管理说明
  - 添加配置刷新说明

- [ ] 10.2 更新部署文档
  - 添加数据库迁移步骤
  - 更新配置文件说明
  - 添加回滚预案

- [ ] 10.3 更新运维手册
  - 添加配置加载监控指标
  - 添加常见故障排查步骤
  - 添加手动刷新操作说明

## 11. 灰度发布准备

- [ ] 11.1 准备灰度发布配置
  - 创建灰度发布配置文件
  - 配置灰度实例路由规则
  - 准备监控看板

- [ ] 11.2 准备回滚预案
  - 保留静态 XML 配置文件
  - 准备快速回滚脚本
  - 准备数据库回滚脚本

- [ ] 11.3 准备发布检查清单
  - 数据库迁移检查项
  - 配置加载检查项
  - 性能指标检查项

## 12. 灰度发布

- [ ] 12.1 灰度发布第一个实例
  - 在测试环境发布第一个实例
  - 观察 24 小时稳定性
  - 收集性能指标

- [ ] 12.2 验证灰度实例功能
  - 验证配置加载正常
  - 验证多租户隔离正常
  - 验证配置刷新正常
  - 验证手动刷新 API 正常

- [ ] 12.3 扩大灰度范围
  - 逐步发布更多实例（10% → 50% → 100%）
  - 每个阶段观察 24 小时
  - 收集监控数据

## 13. 全量发布

- [ ] 13.1 全量发布所有实例
  - 将所有实例切换到 SQL 配置源
  - 验证所有实例配置同步正常
  - 验证负载均衡正常

- [ ] 13.2 清理遗留文件
  - （可选）移除 `classpath:flow/` 下的 XML 文件
  - （可选）移除 `application.yml` 中的静态配置注释

- [ ] 13.3 发布后验证
  - 验证所有功能正常
  - 验证性能指标达标
  - 验证监控告警正常

## 14. 发布后优化

- [ ] 14.1 收集运行数据
  - 收集配置加载性能数据
  - 收集配置刷新频率数据
  - 收集错误日志

- [ ] 14.2 优化配置
  - 根据数据调整轮询间隔
  - 优化慢查询
  - 调整缓存策略

- [ ] 14.3 复盘和总结
  - 总结发布过程中的问题
  - 更新最佳实践文档
  - 规划后续改进
