## Context

当前系统是一个基于 Maven 的 Java 项目，需要引入规则引擎和流程编排能力来处理复杂的业务规则和多变的业务流程。现有的业务规则硬编码在代码中，难以维护和扩展，无法快速响应业务变化。

系统采用 Spring Boot 框架，需要在不破坏现有架构的基础上集成 LiteFlow 引擎。需求包括同时支持 XML 文件配置和动态数据库配置两种方式，并提供规则版本管理、测试调试、监控统计和完整的 CRUD 管理接口。

### 约束条件

- 必须使用 Maven 进行依赖管理
- 必须与 Spring Boot 框架无缝集成
- 核心稳定流程使用 XML 配置，可变规则使用动态加载
- 必须提供规则版本管理、测试和监控功能
- 测试环境必须与生产数据隔离

## System Architecture

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Client Layer                                  │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐             │
│  │   Web UI   │  │  Mobile   │  │  3rd Party│  │   Admin   │             │
│  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘             │
└────────┼───────────────┼───────────────┼───────────────┼───────────────┘
         │               │               │               │
         └───────────────┴───────────────┴───────────────┘
                                 │
         ┌───────────────────────────────┼───────────────────────────────┐
         │                           │                           │
         ▼                           ▼                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      API Gateway / Load Balancer                           │
└────────────────────────────────────────┬────────────────────────────────────────┘
                                     │
         ┌─────────────────────────────┼─────────────────────────────┐
         │                             │                             │
         ▼                             ▼                             ▼
┌─────────────────┐        ┌─────────────────┐        ┌─────────────────┐
│  Application   │        │  Application   │        │  Application   │
│   Server 1    │        │   Server 2    │        │   Server N    │
└───────┬───────┘        └───────┬───────┘        └───────┬───────┘
        │                         │                         │
        │                         │                         │
        ▼                         ▼                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         Spring Boot Application                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                     REST API Layer                                 │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────┐  │   │
│  │  │Component │  │  Chain   │  │Version  │  │  Testing    │  │   │
│  │  │Controller│  │Controller│  │Controller│ │ Controller  │  │   │
│  │  └────┬────┘  └────┬────┘  └────┬────┘  └──────┬──────┘  │   │
│  └───────┼───────────────┼───────────────┼────────────┼─────────┘   │
│          │               │               │               │               │   │
│  ┌───────┼───────────────┼───────────────┼────────────┼─────────┐   │
│  │       │               │               │               │         │     │   │
│  │   ┌───▼───┐       ┌───▼───┐       ┌───▼───┐   ┌───▼───┐ │   │
│  │   │Component│       │ Chain  │       │Version │   │Testing │ │   │
│  │   │ Service│       │Service │       │Service │   │Service │ │   │
│  │   └───┬───┘       └───┬───┘       └───┬───┘   └───┬───┘ │   │
│  │       │               │               │               │     │   │   │
│  │   ┌───▼───────────────▼───────────────▼───────────────▼─────┐ │   │
│  │   │              LiteFlow Engine                                 │ │   │
│  │   │  ┌─────────────────────────────────────────────────────┐  │ │   │
│  │   │  │            Flow Executor                              │  │ │   │
│  │   │  │  ┌───────────────────────────────────────────────┐ │ │   │
│  │   │  │  │            Transaction Manager                │ │ │   │
│  │   │  │  └───────────────────────────────────────────────┘ │ │   │
│  │   │  │  ┌───────────────────────────────────────────────┐ │ │   │
│  │   │  │  │            Component Registry               │ │ │   │
│  │   │  │  └───────────────────────────────────────────────┘ │ │   │
│  │   │  │  ┌───────────────────────────────────────────────┐ │ │   │
│  │   │  │  │            Chain Config Loader              │ │ │   │
│  │   │  │  └───────────────────────────────────────────────┘ │ │   │
│  │   │  └─────────────────────────────────────────────────────┘  │ │   │
│  │   └────────────────────┬──────────────────────────────────────┘ │   │
│  │                        │                                    │   │
│  │   ┌────────────────────▼────────────────────────────────────┐ │   │
│  │   │                Rule Components (Business Logic)          │ │   │
│  │   │  ┌─────────┐  ┌─────────┐  ┌─────────┐          │ │   │
│  │   │  │Component │  │Component │  │Component │  ...     │ │   │
│  │   │  │   A     │  │   B     │  │   C     │          │ │   │
│  │   │  └─────────┘  └─────────┘  └─────────┘          │ │   │
│  │   └────────────────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                      Data Access Layer                          │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐              │  │
│  │  │Component │  │  Chain  │  │Version  │              │  │
│  │  │Repository│  │Repository│  │Repository│              │  │
│  │  └────┬────┘  └────┬────┘  └────┬────┘              │  │
│  └───────┼─────────────┼─────────────┼──────────────────────┘  │
│          │             │             │                          │
└──────────┼─────────────┼─────────────┼──────────────────────────┘
           │             │             │
           ▼             ▼             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            MySQL Database                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │rule_component   │  │  flow_chain    │  │config_version  │     │
│  │                │  │                │  │                │     │
│  │flow_sub_chain  │  │config_test_case│  │execution_      │     │
│  │                │  │                │  │monitoring      │     │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘     │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                   Caffeine Cache                             │    │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐               │    │
│  │  │Component │  │  Chain  │  │Version  │               │    │
│  │  │  Cache  │  │  Cache  │  │  Cache  │               │    │
│  │  └─────────┘  └─────────┘  └─────────┘               │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### LiteFlow 集成架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Spring Boot Application                          │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                      Configuration Layer                           │   │
│  │  ┌─────────────────┐  ┌─────────────────┐                   │   │
│  │  │application.yml  │  │   XML Config   │                   │   │
│  │  │(LiteFlow Config)│  │ (flow/*.xml)   │                   │   │
│  │  └────────┬────────┘  └────────┬────────┘                   │   │
│  │           │                      │                             │   │
│  │           └──────────────┬───────┘                             │   │
│  │                          ▼                                     │   │
│  │  ┌───────────────────────────────────────────────────────┐        │   │
│  │  │         LiteFlow Auto Configuration               │        │   │
│  │  │  - Component Scanning                          │        │   │
│  │  │  - Flow Executor Bean                         │        │   │
│  │  │  - Transaction Manager Integration            │        │   │
│  │  └─────────────────────┬─────────────────────────┘        │   │
│  │                        │                                   │   │
│  │                        ▼                                   │   │
│  │  ┌───────────────────────────────────────────────────────┐        │   │
│  │  │            Flow Config Loader                   │        │   │
│  │  │  ┌──────────────────┐  ┌──────────────────┐        │   │
│  │  │  │ XML Loader      │  │ DB Loader       │        │   │
│  │  │  │ (Core Chains)  │  │ (Dynamic Rules) │        │   │
│  │  │  └────────┬────────┘  └────────┬────────┘        │   │
│  │  │           │                     │                  │   │
│  │  │           └──────────┬──────────┘                  │   │
│  │  │                      ▼                             │   │
│  │  │  ┌───────────────────────────────────────┐          │   │
│  │  │  │      Caffeine Local Cache            │          │   │
│  │  │  │  - Chain Configs                 │          │   │
│  │  │  │  - Component Metadata             │          │   │
│  │  │  └───────────────────────────────────────┘          │   │
│  │  └─────────────────────┬─────────────────────────────────┘   │   │
│  │                        │                                   │   │
│  └────────────────────────┼───────────────────────────────────┘   │
│                         │                                       │
│  ┌────────────────────────▼───────────────────────────────────┐   │
│  │                 Flow Executor                             │   │
│  │  ┌───────────────────────────────────────────────────┐  │   │
│  │  │         Component Registry                        │  │   │
│  │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐   │  │   │
│  │  │  │Business │  │Condition│  │  Loop   │   │  │   │
│  │  │  │Components│ │Components│ │Components│   │  │   │
│  │  │  └─────────┘  └─────────┘  └─────────┘   │  │   │
│  │  └───────────────────────────────────────────────────┘  │   │
│  │                                                          │   │
│  │  ┌───────────────────────────────────────────────────┐  │   │
│  │  │         EL Expression Parser                  │  │   │
│  │  │  - THEN, WHEN, IF, FOR, CATCH             │  │   │
│  │  │  - subChain, PRE, FINALLY                │  │   │
│  │  └───────────────────────────────────────────────────┘  │   │
│  │                                                          │   │
│  │  ┌───────────────────────────────────────────────────┐  │   │
│  │  │         Transaction Manager                    │  │   │
│  │  │  - @LiteflowTransaction Support               │  │   │
│  │  │  - Flow-level Transactions                  │  │   │
│  │  │  - Component-level Transactions            │  │   │
│  │  └───────────────────────────────────────────────────┘  │   │
│  └────────────────────────┬──────────────────────────────────┘   │
│                         │                                       │
│  ┌────────────────────────▼───────────────────────────────────┐   │
│  │              Execution Context                          │   │
│  │  - Request Data                                       │   │
│  │  - Context Bean                                       │   │
│  │  - Component Variables                                 │   │
│  └───────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### 组件与流程关系图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Component Repository                             │
│                                                                          │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐             │
│  │ Component A │     │ Component B │     │ Component C │             │
│  │(Validation) │     │(Check Stock)│     │(Create Order)│             │
│  └──────┬──────┘     └──────┬──────┘     └──────┬──────┘             │
└─────────┼──────────────────┼──────────────────┼──────────────────┘          │
          │                  │                  │                          │
          │                  │                  │                          │
          └──────────────────┼──────────────────┘                          │
                             │                                           │
         ┌─────────────────────▼──────────────────────┐                     │
         │          Flow Chain Repository             │                     │
         │                                         │                     │
         │  ┌─────────────────────────────────────┐  │                     │
         │  │   Order Process Chain            │  │                     │
         │  │   EL: THEN(A, WHEN(B, C), D)    │  │                     │
         │  └───────────┬─────────────────────┘  │                     │
         │              │                           │                     │
         │              ▼                           │                     │
         │  ┌─────────────────────────────────────┐  │                     │
         │  │   VIP Approval Chain             │  │                     │
         │  │   EL: IF(E, THEN(F, G))        │  │                     │
         │  └───────────┬─────────────────────┘  │                     │
         │              │                           │                     │
         │              ▼                           │                     │
         │  ┌─────────────────────────────────────┐  │                     │
         │  │   Sub Chain: Notify Process     │  │                     │
         │  │   EL: THEN(H, I)               │  │                     │
         │  └─────────────────────────────────────┘  │                     │
         └─────────────────────────────────────────────┘                     │
                                                                          │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 数据流向图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Request Flow                                   │
│                                                                          │
│  Client Request                                                        │
│       │                                                                 │
│       ▼                                                                 │
│  ┌─────────────────┐                                                   │
│  │ REST API Layer │                                                   │
│  │ /api/execute/ │                                                   │
│  │   {chainName}   │                                                   │
│  └────────┬────────┘                                                   │
│           │                                                             │
│           ▼                                                             │
│  ┌─────────────────┐                                                   │
│  │ Execution Service │                                                   │
│  │  - Validate    │                                                   │
│  │  - Prepare     │                                                   │
│  └────────┬────────┘                                                   │
│           │                                                             │
│           ▼                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │                    LiteFlow Engine                             │   │
│  │                                                               │   │
│  │  1. Load Chain Config                                          │   │
│  │     ┌──────────────┐  ┌──────────────┐                          │   │
│  │     │ XML / Cache  │  │  DB / Cache  │                          │   │
│  │     └──────┬───────┘  └──────┬───────┘                          │   │
│  │            └────────┬─────────┘                                    │   │
│  │                     ▼                                             │   │
│  │            ┌───────────────────┐                                     │   │
│  │            │ EL Expression    │                                     │   │
│  │            │     Parser      │                                     │   │
│  │            └─────────┬───────┘                                     │   │
│  │                      │                                             │   │
│  │                      ▼                                             │   │
│  │  2. Parse EL Expression                                          │   │
│  │     THEN(A, WHEN(B, C), D)                                      │   │
│  │                      │                                             │   │
│  │                      ▼                                             │   │
│  │  3. Execute Components                                           │   │
│  │     ┌───────────────────────────────────────────────┐               │   │
│  │     │ Execution Sequence                     │               │   │
│  │     │                                    │               │   │
│  │     │  ┌──────┐  ┌──────┐  ┌──────┐            │   │
│  │     │  │  A   │  │  B   │  │  C   │            │   │
│  │     │  └───┬──┘  └───┬──┘  └───┬──┘            │   │
│  │     │      │          │          │                  │   │
│  │     │      └────┬─────┘          │                  │   │
│  │     │           │                 │                  │   │
│  │     │           ▼                 ▼                  │   │
│  │     │      ┌──────────┐  ┌──────────┐            │   │
│  │     │      │    D     │  │    E     │            │   │
│  │     │      └────┬─────┘  └────┬─────┘            │   │
│  │     └───────────┼───────────────┼───────────────────┘   │
│  │                 │               │                          │   │
│  │                 ▼               │                          │   │
│  │  4. Handle Transaction                                      │   │
│  │     ┌───────────────────────────────────────┐               │   │
│  │     │ Transaction Manager               │               │   │
│  │     │ - Begin/Commit/Rollback              │               │   │
│  │     └───────────────────────────────────────┘               │   │
│  │                 │                                          │   │
│  │                 ▼                                          │   │
│  │  5. Collect Monitoring Data                                  │   │
│  │     ┌───────────────────────────────────────┐               │   │
│  │     │ Monitoring Collector               │               │   │
│  │     │ - Execution Time                               │               │   │
│  │     │ - Component Status                            │               │   │
│  │     │ - Error Information                          │               │   │
│  │     └───────────────────────────────────────┘               │   │
│  │                 │                                          │   │
│  │                 ▼                                          │   │
│  │  6. Return Result                                            │   │
│  └───────────────────────────────┬──────────────────────────────────┘   │
│                              │                                     │
│                              ▼                                     │
│  ┌─────────────────┐                                                   │
│  │ Response Body  │                                                   │
│  │ {              │                                                   │
│  │   "success": true,                                                 │
│  │   "executionId": "...",                                               │
│  │   "result": {...},                                                 │
│  │   "path": [A, B, C, D]                                             │
│  │ }                                                                  │
│  └──────┬──────────┘                                                   │
│         │                                                             │
│         ▼                                                             │
│   Client Response                                                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 监控架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      Monitoring & Tracing Architecture                    │
│                                                                          │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │                   Flow Execution                               │   │
│  │                                                               │   │
│  │  Component A ──► Component B ──► Component C ──► Result   │   │
│  │      │               │               │                           │   │
│  │      ▼               ▼               ▼                           │   │
│  │  ┌─────────┐    ┌─────────┐    ┌─────────┐                │   │
│  │  │ 100ms   │    │  50ms   │    │  200ms  │                │   │
│  │  │ Success │    │ Success │    │ Success │                │   │
│  │  └────┬────┘    └────┬────┘    └────┬────┘                │   │
│  └───────┼───────────────┼───────────────┼──────────────┘          │
│          │               │               │                          │
│          ▼               ▼               ▼                          │
│  ┌───────────────────────────────────────────────────────────────┐        │   │
│  │          Monitoring Collector                         │        │   │
│  │  ┌─────────────────────────────────────────────────────┐  │        │   │
│  │  │         Metrics Collector                     │  │        │   │
│  │  │  - Execution Count                              │  │        │   │
│  │  │  - Success/Failure Rate                        │  │        │   │
│  │  │  - Average Time                               │  │        │   │
│  │  └──────────────────┬──────────────────────────────┘  │        │   │
│  │                   │                                 │        │   │
│  │  ┌────────────────▼──────────────────────────────┐  │        │   │
│  │  │         Trace Collector                     │  │        │   │
│  │  │  - Component Execution Path                  │  │        │   │
│  │  │  - Data Flow                                 │  │        │   │
│  │  │  - Error Location                            │  │        │   │
│  │  └──────────────────┬──────────────────────────────┘  │        │   │
│  │                   │                                 │        │   │
│  │  ┌────────────────▼──────────────────────────────┐  │        │   │
│  │  │         Alert Manager                      │  │        │   │
│  │  │  - Failure Rate Check                        │  │        │   │
│  │  │  - Slow Transaction Alert                   │  │        │   │
│  │  └──────────────────┬──────────────────────────────┘  │        │   │
│  └───────────────────────┼──────────────────────────────────┘          │
│                          │                                             │
│          ┌───────────────┼───────────────┐                          │
│          │               │               │                          │
│          ▼               ▼               ▼                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │   MySQL     │  │ Caffeine    │  │ Alert      │             │
│  │ Monitoring  │  │ Stats Cache │  │ Service    │             │
│  │    Table    │  │             │  │            │             │
│  └─────────────┘  └─────────────┘  └─────┬──────┘             │
│                                        │                         │
│                         ┌──────────────▼──────────────┐             │
│                         │   Email / DingTalk     │             │
│                         │   WeCom Notification   │             │
│                         └─────────────────────────┘             │
└─────────────────────────────────────────────────────────────────────────────┘
```


## Goals / Non-Goals

**Goals:**
- 集成 LiteFlow 引擎，同时支持规则引擎和流程编排能力
- 实现基于 EL 表达式的灵活流程编排，支持串行、并行、条件、循环等编排模式
- 实现规则组件与流程编排的无缝整合，组件可被多个流程复用
- 实现混合配置模式（XML + 动态数据库加载）
- 提供完整的规则和流程版本管理功能
- 实现规则和流程测试调试工具，支持断点和执行路径可视化
- 提供规则和流程执行监控和异常告警能力
- 提供完整的规则和流程管理 REST API

**Non-Goals:**
- 可视化规则编辑器（后期迭代）
- 规则模板化（后期迭代）
- 规则权限细粒度控制（使用 Spring Security 基础权限即可）
- 规则性能分析和优化建议（监控仅提供基础统计）

## Decisions

### 1. LiteFlow 版本选择

**决策**: 使用 LiteFlow 2.12.x 版本

**理由**:
- LiteFlow 2.12.x 是当前稳定的主版本，支持 Spring Boot 3.x
- 提供完善的数据库动态加载支持
- 内置监控和统计功能，减少开发工作量
- 社区活跃，文档完善

**替代方案考虑**:
- LiteFlow 2.11.x：功能相对较旧，不推荐
- Drools：功能更强大但学习曲线陡峭，配置复杂，过度设计

### 2. 混合配置模式架构

**决策**: 核心稳定流程使用 XML 文件，可变规则使用数据库动态加载

**理由**:
- XML 配置适合稳定、版本控制严格的核心流程
- 数据库动态加载适合频繁变更的业务规则
- 混合模式兼顾稳定性和灵活性
- 符合配置管理的最佳实践

**实现方式**:
```yaml
liteflow:
  rule-source:
    configData: classpath:flow/  # XML 文件路径
  script-file-function-data:    # 数据库动态加载
    enabled: true
    sql: "SELECT rule_content FROM rule_config WHERE rule_name = ? AND status = 'ACTIVE'"
```

### 3. 流程编排架构

**决策**: 使用 LiteFlow 的 EL 表达式实现流程编排，支持多种编排模式

**理由**:
- LiteFlow 提供强大的 EL 表达式，支持串行、并行、条件、循环等复杂编排
- 规则组件与流程编排天然融合，组件可被多个流程复用
- EL 表达式简洁易读，非技术人员也能理解流程逻辑
- 支持子流程编排，可实现流程嵌套和复用
- 内置流程执行监控和状态追踪能力

**支持的编排模式**:

1. **串行编排**: `THEN(a, b, c)` - 依次执行 a、b、c 组件
2. **并行编排**: `WHEN(a, b, c)` - 并行执行 a、b、c 组件
3. **条件编排**: `IF(cond, a, b)` - 条件成立执行 a，否则执行 b
4. **循环编排**: `FOR(n).DO(a)` - 循环 n 次执行 a 组件
5. **异常捕获**: `CATCH(a, b)` - a 组件异常时执行 b
6. **子流程编排**: `subChain(subflow)` - 调用子流程
7. **编排模式组合**: `THEN(a, WHEN(b, c), IF(d, e, f))` - 组合多种模式

**流程编排与规则的整合**:

- **规则组件作为最小执行单元**: 每个 `@LiteflowComponent` 注解的类都是可被编排的组件
- **流程链定义业务流程**: 通过 EL 表达式将多个规则组件组合成业务流程
- **规则逻辑内聚在组件中**: 复杂的业务逻辑封装在组件内部，流程编排只关注执行顺序和条件
- **组件复用**: 同一个组件可被多个流程链引用，避免重复开发
- **动态流程编排**: 流程链配置可存储在数据库中，实现动态调整

**示例流程**:
```xml
<!-- 订单审核流程 -->
<chain name="orderApprovalChain">
    THEN(
        validateOrder,           <!-- 验证订单 -->
        WHEN(
            checkStock,          <!-- 库存检查（并行） -->
            calculateAmount      <!-- 金额计算（并行） -->
        ),
        IF(
            isVIPUser,           <!-- 条件判断 -->
            vipApproval,         <!-- VIP 审批 -->
            THEN(
                normalApproval,  <!-- 普通审批 -->
                sendNotify       <!-- 发送通知 -->
            )
        ),
        createOrder             <!-- 创建订单 -->
    )
</chain>
```

**流程配置管理**:
- 核心业务流程使用 XML 文件配置，进行版本控制
- 可变业务流程使用数据库动态加载
- 流程链配置支持参数化，可灵活调整组件执行逻辑
- 子流程支持独立配置和复用

### 4. 数据库表设计

**决策**: 使用 6 张表管理规则、流程、版本和监控数据

**理由**:
- 规则组件表存储可复用的业务组件
- 流程链表存储流程编排配置
- 版本表存储规则和流程的历史版本
- 子流程表支持流程嵌套和复用
- 测试用例表独立存储，与规则/流程版本关联
- 监控数据表使用时序表设计，便于数据聚合

**表结构**:

1. `rule_component` - 规则组件表
   - id, component_id, component_name, description, component_type, status, created_at, updated_at

2. `flow_chain` - 流程链表
   - id, chain_name, chain_code, description, config_type, status, current_version, created_at, updated_at, deleted_at

3. `flow_sub_chain` - 子流程表
   - id, sub_chain_name, chain_code, description, parent_chain_id, status, created_at, updated_at

4. `config_version` - 配置版本表（统一管理规则和流程版本）
   - id, config_type, config_id, version, content, status, created_by, created_at
   - config_type: COMPONENT/CHAIN/SUB_CHAIN

5. `config_test_case` - 测试用例表
   - id, config_type, config_id, name, input_data, expected_result, created_at

6. `execution_monitoring` - 执行监控表（时序表设计）
   - id, chain_id, component_id, chain_execution_id, execute_time, status, error_message, created_at

### 5. 监控数据存储方案

**决策**: 使用 MySQL 存储监控数据，通过定时任务聚合统计

**理由**:
- 项目已使用 MySQL，避免引入新的存储系统
- 监控数据量可控，使用 MySQL 足够
- 通过定时任务实现数据聚合，减少存储开销
- 同时支持规则组件监控和流程链监控

**监控指标**:

1. **流程级监控**:
   - 流程执行次数和成功率
   - 流程平均执行耗时
   - 流程执行路径追踪
   - 流程异常统计

2. **组件级监控**:
   - 组件执行次数和成功率
   - 组件平均执行耗时
   - 组件被引用的流程数量
   - 组件异常统计

3. **链路追踪**:
   - 单次流程执行的完整路径
   - 每个组件的执行时间和状态
   - 组件间的数据传递
   - 异常发生位置和原因

**聚合策略**:
- 原始数据保留 7 天
- 小时级统计数据保留 30 天
- 日级统计数据保留 1 年

### 6. 规则与流程测试隔离方案

**决策**: 使用独立的测试上下文执行器，模拟数据而不修改生产数据

**理由**:
- 不需要搭建独立的测试环境，降低复杂度
- 通过内存 Mock 实现隔离，执行速度快
- 测试结果可重复，便于调试
- 支持规则组件测试和流程链测试两种场景

**实现方式**:
- 创建测试专用的 FlowExecutor
- 使用 Mock 数据源，不连接真实数据库
- 测试执行后清理上下文
- 流程测试提供完整的执行路径追踪

**测试覆盖范围**:
1. **组件级测试**: 测试单个规则组件的输入输出逻辑
2. **流程级测试**: 测试完整流程链的执行路径和结果
3. **子流程测试**: 测试子流程的独立性和复用性
4. **异常场景测试**: 测试异常处理和错误恢复机制

### 7. 版本对比实现方案

**决策**: 使用 Java diff 库进行文本对比

**理由**:
- Java-diff-utils 库成熟稳定
- 支持 HTML 格式化输出，便于展示
- 不依赖外部服务

### 8. 异常告警实现

**决策**: 使用 Spring Boot 自带的 Actuator 健康检查 + 自定义告警服务

**理由**:
- Actuator 提供基础健康检查能力
- 自定义告警服务通过邮件/钉钉/企业微信发送告警
- 避免引入复杂的告警系统

### 9. API 权限控制

**决策**: 使用 Spring Security + 自定义注解实现基础权限控制

**理由**:
- Spring Security 成熟稳定
- 自定义 `@RequireRole` 注解简洁易用
- 满足当前需求，避免过度设计

**实现方式**:
```java
@RequireRole("RULE_ADMIN")
public class RuleController { ... }
```

### 10. 包结构设计

**决策**: 按功能模块划分包结构

**理由**:
- 功能模块清晰，易于维护
- 符合 Spring Boot 最佳实践
- 便于后续扩展

**包结构**:
```
com.xxx.liteflow
├── component           # 规则组件
│   ├── base           # 基础组件类（NodeComponent 基类）
│   ├── business       # 业务规则组件
│   ├── condition      # 条件判断组件
│   └── loop           # 循环控制组件
├── flow               # 流程编排
│   ├── chain          # 流程链管理
│   ├── subchain       # 子流程管理
│   └── executor       # 流程执行器
├── config             # 配置类
├── controller         # REST 控制器
│   ├── component      # 组件管理接口
│   ├── chain          # 流程链管理接口
│   └── execution      # 流程执行接口
├── service            # 业务服务
│   ├── component      # 组件管理服务
│   ├── chain          # 流程链管理服务
│   ├── version        # 版本管理服务
│   ├── testing        # 测试服务
│   └── monitoring     # 监控服务
├── repository         # 数据访问层
├── model              # 数据模型
│   ├── entity         # 实体类
│   ├── dto            # 数据传输对象
│   └── vo             # 视图对象
└── util               # 工具类
```

### 11. 流程事务管理

**决策**: 使用 Spring TransactionManager 实现流程级事务，通过注解方式配置组件的事务需求

**理由**:
- 业务流程通常涉及多个数据库操作，需要事务保证数据一致性
- 不是所有组件都需要事务（如查询、外部调用等）
- 灵活配置可以满足不同业务场景的事务需求
- LiteFlow 与 Spring 事务机制天然兼容

**事务策略**:

1. **流程级事务**: 整个流程链在一个事务中执行
   - 适用场景：流程中所有组件都是写操作且强一致性要求
   - 优点：简单，全流程原子性
   - 缺点：长事务锁定资源，影响并发

2. **组件级事务**: 每个组件独立管理事务
   - 适用场景：组件之间数据一致性要求不高
   - 优点：组件独立，失败不影响其他组件
   - 缺点：无法保证跨组件一致性

3. **混合事务策略**: 灵活组合流程级和组件级事务
   - 适用场景：复杂业务流程
   - 优点：平衡一致性和性能
   - 缺点：配置复杂度较高

**实现方式**:

1. **组件事务注解**:
```java
@Component("createOrder")
@LiteflowTransaction(TransactionalType.REQUIRED)  // 需要事务
public class CreateOrderComponent extends NodeComponent {
    @Override
    public void process() {
        // 组件逻辑，自动加入事务
    }
}

@Component("queryOrder")
@LiteflowTransaction(TransactionalType.NOT_SUPPORTED)  // 不需要事务
public class QueryOrderComponent extends NodeComponent {
    @Override
    public void process() {
        // 查询操作，不使用事务
    }
}

@Component("sendNotify")
@LiteflowTransaction(TransactionalType.NOT_SUPPORTED)  // 不需要事务
public class SendNotifyComponent extends NodeComponent {
    @Override
    public void process() {
        // 外部调用（如邮件、短信），不使用事务
    }
}
```

2. **流程级事务配置**:
```xml
<!-- XML 配置方式 -->
<chain name="orderProcessChain" transactional="true">
    THEN(
        validateOrder,
        checkStock,
        createOrder,
        sendNotify
    )
</chain>
```

或者通过 EL 表达式包装:
```xml
<chain name="orderProcessChain">
    transaction(
        THEN(
            validateOrder,
            checkStock,
            createOrder,
            sendNotify
        )
    )
</chain>
```

3. **数据库配置**:
```yaml
liteflow:
  transaction:
    enabled: true
    manager: springTransactionManager  # 使用 Spring 事务管理器
    default-propagation: REQUIRED   # 默认事务传播行为
    default-timeout: 30          # 默认事务超时时间（秒）
```

4. **事务传播类型**:
```java
public enum TransactionalType {
    REQUIRED,      // 需要事务（默认）
    REQUIRES_NEW,  // 总是新建事务
    NOT_SUPPORTED,  // 不支持事务
    MANDATORY,     // 必须在已有事务中
    NEVER,         // 从不在事务中
    SUPPORTS       // 如果有事务则加入
}
```

5. **事务配置表扩展**:

在 `flow_chain` 表中添加事务配置字段:
```sql
ALTER TABLE flow_chain ADD COLUMN transactional TINYINT DEFAULT 0 COMMENT '是否启用流程级事务: 0-否 1-是';
ALTER TABLE flow_chain ADD COLUMN transaction_timeout INT DEFAULT 30 COMMENT '事务超时时间(秒)';
ALTER TABLE flow_chain ADD COLUMN transaction_propagation VARCHAR(20) DEFAULT 'REQUIRED' COMMENT '事务传播行为';
```

在 `rule_component` 表中添加组件事务配置字段:
```sql
ALTER TABLE rule_component ADD COLUMN transactional_type VARCHAR(20) DEFAULT 'REQUIRED' COMMENT '事务类型';
```

**组件事务需求判断规则**:

| 组件类型 | 事务需求 | 推荐配置 | 示例 |
|---------|---------|----------|------|
| **数据插入/更新** | 需要 | REQUIRED/REQUIRES_NEW | 创建订单、更新库存 |
| **数据删除** | 需要 | REQUIRED | 删除用户、取消订单 |
| **数据查询** | 不需要 | NOT_SUPPORTED/SUPPORTS | 查询订单、获取配置 |
| **计算处理** | 不需要 | NOT_SUPPORTED | 金额计算、条件判断 |
| **外部调用** | 不需要 | NOT_SUPPORTED | 发送邮件、调用第三方API |
| **日志记录** | 不需要 | NOT_SUPPORTED | 写日志、记录审计 |
| **缓存操作** | 不需要 | NOT_SUPPORTED | 更新缓存、清理缓存 |

**事务回滚策略**:

1. **自动回滚**: 组件抛出 RuntimeException 时自动回滚
```java
@Component("createOrder")
@LiteflowTransaction(rollbackFor = {BusinessException.class})
public class CreateOrderComponent extends NodeComponent {
    @Override
    public void process() throws BusinessException {
        // 业务逻辑，抛出异常时回滚
    }
}
```

2. **流程级回滚**: 流程中任一组件失败，回滚整个流程
```java
@Component("orderProcessChain")
@FlowChainTransactional(rollbackOnFailure = true)
public class OrderProcessChain extends NodeComponent {
    @Override
    public void process() {
        // 流程级事务
    }
}
```

3. **补偿事务（Saga 模式）**: 用于分布式场景
```xml
<chain name="orderChain">
    THEN(
        createOrder,
        WHEN(
            checkStock,
            deductBalance
        ),
        IF(
            paymentSuccess,
            sendNotify,
            compensation(
                createOrder,
                checkStock,
                deductBalance
            )
        )
    )
</chain>
```

**事务监控**:

1. **事务执行记录**: 记录事务开始、提交、回滚时间和状态
2. **事务超时监控**: 监控长事务，超过阈值告警
3. **死锁检测**: 记录死锁信息，便于排查
4. **事务统计**: 统计事务成功率、回滚率

**示例场景**:

```xml
<!-- 订单处理流程 - 混合事务配置 -->
<chain name="orderProcessChain" transactional="true">
    THEN(
        validateOrder,        <!-- REQUIRED: 验证订单（查询，可选事务） -->
        WHEN(
            checkStock,          <!-- REQUIRED: 扣减库存（需要事务） -->
            calculateAmount      <!-- NOT_SUPPORTED: 金额计算（不需要事务） -->
        ),
        IF(
            isVIPUser,
            THEN(
                vipApproval      <!-- REQUIRED: VIP审批（可能需要事务） -->
            ),
            THEN(
                normalApproval,  <!-- REQUIRED: 普通审批 -->
                createOrder      <!-- REQUIRES_NEW: 创建订单（新建事务） -->
            )
        ),
        sendNotify           <!-- NOT_SUPPORTED: 发送通知（外部调用，不需要事务） -->
    )
</chain>
```

```java
@Component("validateOrder")
@LiteflowTransaction(TransactionalType.SUPPORTS)  // 支持事务，但不强制
public class ValidateOrderComponent extends NodeComponent {
    @Override
    public void process() {
        // 查询验证，如果在事务中则加入
    }
}

@Component("checkStock")
@LiteflowTransaction(TransactionalType.REQUIRED)  // 必须有事务
public class CheckStockComponent extends NodeComponent {
    @Override
    public void process() {
        // 扣减库存，必须在事务中
    }
}

@Component("createOrder")
@LiteflowTransaction(TransactionalType.REQUIRES_NEW)  // 独立新事务
public class CreateOrderComponent extends NodeComponent {
    @Override
    public void process() {
        // 创建订单，使用独立事务
    }
}

@Component("sendNotify")
@LiteflowTransaction(TransactionalType.NOT_SUPPORTED)  // 不使用事务
public class SendNotifyComponent extends NodeComponent {
    @Override
    public void process() {
        // 发送通知（邮件/短信），不使用事务
    }
}
```

### 12. 规则与流程组件异常处理

**决策**: 全局异常处理器 + 组件级异常配置

**理由**:
- 全局异常处理器统一处理异常
- 组件级异常配置支持灵活控制（继续执行/中止流程）
- 便于日志记录和监控

**实现方式**:
```java
@Component("exceptionHandler")
public class GlobalExceptionHandler extends NodeComponent {
    @Override
    public void process() {
        // 全局异常处理
    }
}
```

## Risks / Trade-offs

### 风险 1: 数据库动态规则加载性能

**描述**: 频繁从数据库加载规则可能影响性能

**缓解措施**:
- 实现本地缓存（Caffeine），缓存已加载的规则
- 配置缓存刷新策略（时间/事件触发）
- 数据库查询添加索引，优化查询性能

### 风险 2: 监控数据量过大

**描述**: 规则执行频繁时，监控数据可能快速增长

**缓解措施**:
- 实现数据聚合策略（原始数据 → 小时级 → 日级）
- 定时清理过期数据
- 可配置采样率，减少数据量

### 风险 3: 规则版本管理复杂性

**描述**: 版本过多可能导致管理复杂

**缓解措施**:
- 限制版本数量上限（如最多保留 50 个版本）
- 提供版本归档功能
- 定期清理旧版本

### 风险 4: 测试环境隔离不彻底

**描述**: 测试可能意外修改生产数据

**缓解措施**:
- 使用 Mock 数据源，确保测试不连接真实数据库
- 测试执行后强制清理上下文
- 添加明确的测试标识，在日志中记录

### 权衡 1: XML vs 数据库配置

**权衡点**: XML 配置简单但不够灵活，数据库配置灵活但复杂

**决策**: 混合模式，核心流程用 XML，可变规则用数据库

### 权衡 2: 监控实时性 vs 存储成本

**权衡点**: 实时监控需要更多存储，减少存储影响分析

**决策**: 原始数据保留 7 天，使用聚合数据支撑长期分析

### 权衡 3: 测试完整性 vs 执行速度

**权衡点**: 完整的隔离测试执行慢，简化测试速度快但不彻底

**决策**: 使用 Mock 数据源实现隔离，平衡速度和完整性

## Migration Plan

### 阶段 1: 基础集成（Week 1-2）

1. 引入 LiteFlow 依赖和配置
2. 创建基础的组件开发框架（NodeComponent 基类）
3. 创建流程编排框架（EL 表达式解析器）
4. 实现 XML 配置加载（流程链和规则组件）
5. 搭建基础的数据库表结构（组件表、流程链表）

### 阶段 2: 动态配置加载（Week 3）

1. 实现数据库动态流程链加载
2. 实现数据库动态规则组件加载
3. 实现配置验证功能（EL 表达式语法检查、组件存在性检查）
4. 实现流程链热更新机制
5. 添加本地缓存（Caffeine）
6. 实现子流程配置和加载

### 阶段 3: 版本管理（Week 4）

1. 实现流程链版本存储
2. 实现规则组件版本存储
3. 实现子流程版本存储
4. 实现版本对比功能（EL 表达式 diff）
5. 实现版本回滚功能
6. 实现版本状态管理（草稿、已发布、已废弃）

### 阶段 4: 测试调试（Week 5）

1. 实现规则组件测试功能（单元测试）
2. 实现流程链测试功能（集成测试）
3. 实现测试环境隔离
4. 实现执行路径可视化（流程执行图）
5. 实现断点调试功能
6. 实现测试用例管理（组件测试用例、流程测试用例）
7. 实现批量测试和测试报告

### 阶段 5: 监控告警（Week 6）

1. 实现流程链监控数据采集
2. 实现规则组件监控数据采集
3. 实现链路追踪功能
4. 实现监控仪表盘（流程监控、组件监控、链路追踪）
5. 实现数据聚合和清理
6. 实现异常告警（流程失败告警、组件异常告警）

### 阶段 6: 管理 API（Week 7）

1. 实现规则组件 CRUD API
2. 实现流程链 CRUD API
3. 实现子流程管理 API
4. 实现版本管理 API
5. 实现配置验证 API（EL 表达式验证、组件引用检查）
6. 实现测试 API（组件测试、流程测试、批量测试）
7. 实现监控 API（监控数据查询、链路追踪查询）
8. 实现流程执行 API
9. 添加 API 权限控制

### 回滚策略

- 每个阶段完成后创建 Git 标签
- 保留数据库备份，支持快速回滚
- 使用功能开关，可随时禁用新功能

## Open Questions

1. **配置中心选择**: 是否需要集成配置中心（如 Nacos、Apollo）用于动态规则和流程分发？当前设计使用数据库，如需配置中心需要额外集成工作。

2. **规则执行审计**: 是否需要记录规则和流程执行的详细日志（包括输入输出、执行时间等）？当前监控仅记录统计信息，如需详细审计需要额外设计。

3. **规则模板化**: 是否需要支持规则和流程模板，允许快速创建相似规则和流程？当前设计不支持，如需要需要设计模板引擎。

4. **多租户支持**: 是否需要支持多租户，不同租户使用不同的规则集和流程集？当前设计不支持，如需要需要添加租户隔离机制。

5. **规则权限细粒度控制**: 是否需要对规则和流程进行更细粒度的权限控制（如只能查看/修改特定规则/流程的权限）？当前设计使用角色级别的简单权限。

6. **流程可视化编辑器**: 是否需要提供可视化的流程编排编辑器（拖拽式编排）？当前设计使用文本编辑器编写 EL 表达式，可视化编辑器可以降低使用门槛。

7. **流程并行度控制**: 是否需要对流程的并行执行度进行精细化控制（如限制并发数、超时时间等）？当前设计使用 LiteFlow 默认配置。

8. **流程编排模式扩展**: 是否需要支持更复杂的编排模式（如 WHILE 循环、SWITCH 分支、异步编排等）？当前设计支持基础模式。

9. **流程间依赖管理**: 是否需要支持流程间的依赖关系（如一个流程完成后触发另一个流程）？当前设计不支持流程间触发。
